<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG-Clone</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: #e4eaf5; height: 100vh; display: flex; overflow: hidden; }
        
        /* Экраны */
        #loading-screen, #auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; background: white; position: absolute; z-index: 100; }
        #app-screen { display: none; width: 100%; height: 100vh; }
        
        /* Авторизация */
        .auth-box { width: 300px; display: flex; flex-direction: column; gap: 10px; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; outline: none; width: 100%; }
        button { background: #3390ec; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        button:hover { background: #2b7bc5; }
        
        /* Лейаут Telegram */
        #sidebar { width: 300px; background: white; border-right: 1px solid #dfe1e5; display: flex; flex-direction: column; }
        #chat-area { flex: 1; display: flex; flex-direction: column; background: #e4eaf5; }
        
        /* Сайдбар (левая часть) */
        #my-profile { padding: 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #search-box { padding: 10px; background: #f4f4f5; }
        #search-box input { width: 100%; padding: 8px 12px; border-radius: 20px; border: 1px solid #ddd; background: #fff; }
        #user-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .user-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .user-item:hover { background: #f4f4f5; }
        .user-item .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #ccc; }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: bold; font-size: 14px; }
        .user-nick { font-size: 12px; color: #888; }

        /* Окно чата (правая часть) */
        #chat-header { padding: 15px 20px; background: white; border-bottom: 1px solid #dfe1e5; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        #messages-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        #message-input-area { padding: 15px; background: white; display: flex; gap: 10px; align-items: center; }
        
        /* Сообщения */
        .msg-row { display: flex; width: 100%; }
        .msg-row.mine { justify-content: flex-end; }
        .msg-bubble { max-width: 60%; padding: 10px 15px; border-radius: 15px; font-size: 15px; word-wrap: break-word; position: relative; }
        .msg-row.others .msg-bubble { background: white; border-bottom-left-radius: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-row.mine .msg-bubble { background: #eeffde; border-bottom-right-radius: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-time { font-size: 10px; color: #888; text-align: right; margin-top: 4px; display: block; }
        
        /* Настройки (Модальное окно) */
        #settings-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 300px; display: flex; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>

<div id="loading-screen">
    <h2>Загрузка...</h2>
</div>

<div id="auth-screen" style="display: none;">
    <h2>Telegram Clone</h2>
    <div class="auth-box">
        <input type="text" id="reg-username" placeholder="Уникальный @юзернейм (только латиница)">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Пароль">
        <button onclick="register()">Зарегистрироваться</button>
        <button onclick="login()" style="background: transparent; color: #3390ec; border: 1px solid #3390ec;">Уже есть аккаунт? Войти</button>
        <p id="auth-error" style="color: red; font-size: 12px; text-align: center;"></p>
    </div>
</div>

<div id="app-screen">
    <div id="sidebar">
        <div id="my-profile">
            <span id="my-display-name" style="font-weight: bold;">...</span>
            <button onclick="openSettings()" style="width: auto; padding: 5px 10px; font-size: 12px;">Настройки</button>
        </div>
        <div id="search-box">
            <input type="text" id="search-input" placeholder="Поиск по @юзернейму..." oninput="searchUsers()">
        </div>
        <div id="user-list">
            <div style="padding: 10px; text-align: center; color: #888; font-size: 13px;">Введите @юзернейм для поиска</div>
        </div>
    </div>

    <div id="chat-area">
        <div id="chat-header">
            <span id="active-chat-name">Выберите чат</span>
        </div>
        <div id="messages-container"></div>
        <div id="message-input-area" style="display: none;">
            <input type="text" id="msg-input" placeholder="Написать сообщение...">
            <button onclick="sendPrivateMessage()" style="width: auto; padding: 10px 20px;">Отправить</button>
        </div>
    </div>
</div>

<div id="settings-modal">
    <div class="modal-content">
        <h3>Настройки профиля</h3>
        <label>Отображаемое имя:</label>
        <input type="text" id="set-name">
        <label>Ссылка на аватарку:</label>
        <input type="text" id="set-avatar">
        <button onclick="saveSettings()">Сохранить</button>
        <button onclick="closeSettings()" style="background: #ccc; color: black;">Отмена</button>
        <button onclick="logout()" style="background: #e74c3c; margin-top: 15px;">Выйти из аккаунта</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getDatabase, ref, set, get, push, onChildAdded, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // ==========================================
  // ВСТАВЬ ТВОИ КЛЮЧИ ИЗ СКРИНШОТА СЮДА
  // ==========================================
 const firebaseConfig = {
   apiKey: "AIzaSyBuGjs02jnhD-pn4t_6cfgyIR2vn2O9l7c",
   authDomain: "messenger-somik.firebaseapp.com",
   databaseURL: "https://messenger-somik-default-rtdb.europe-west1.firebasedatabase.app",
   projectId: "messenger-somik",
   storageBucket: "messenger-somik.firebasestorage.app",
   messagingSenderId: "332911583024",
   appId: "1:332911583024:web:13d0715ef3994712cd72f5"
};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Фикс "сброса" при перезагрузке - жестко говорим браузеру хранить сессию
  setPersistence(auth, browserLocalPersistence);

  let currentUser = null;
  let myProfile = null;
  let activeChatId = null;
  let currentChatListener = null;

  const UI = {
      loading: document.getElementById('loading-screen'),
      auth: document.getElementById('auth-screen'),
      app: document.getElementById('app-screen'),
      error: document.getElementById('auth-error'),
      userList: document.getElementById('user-list'),
      msgContainer: document.getElementById('messages-container'),
      inputArea: document.getElementById('message-input-area'),
      activeChatName: document.getElementById('active-chat-name')
  };

  // --- АВТОРИЗАЦИЯ И РЕГИСТРАЦИЯ С @USERNAME ---
  window.register = async () => {
      const u = document.getElementById('reg-username').value.trim().toLowerCase();
      const e = document.getElementById('email').value.trim();
      const p = document.getElementById('password').value.trim();
      
      if(!u || !u.startsWith('@')) return UI.error.innerText = "Юзернейм должен начинаться с @";
      
      try {
          // 1. Проверяем, занят ли юзернейм
          const userCheck = await get(ref(db, 'usernames/' + u));
          if(userCheck.exists()) return UI.error.innerText = "Этот @юзернейм уже занят!";
          
          // 2. Создаем аккаунт
          const userCred = await createUserWithEmailAndPassword(auth, e, p);
          const uid = userCred.user.uid;
          
          // 3. Бронируем юзернейм и создаем профиль
          await set(ref(db, 'usernames/' + u), uid);
          await set(ref(db, 'users/' + uid), {
              username: u,
              displayName: "Новый пользователь",
              avatar: "https://cdn-icons-png.flaticon.com/512/149/149071.png"
          });
      } catch(err) { UI.error.innerText = err.message; }
  };

  window.login = () => {
      const e = document.getElementById('email').value.trim();
      const p = document.getElementById('password').value.trim();
      signInWithEmailAndPassword(auth, e, p).catch(err => UI.error.innerText = "Ошибка входа");
  };

  window.logout = () => signOut(auth);

  // --- ЗАГРУЗКА ДАННЫХ ПРИ ВХОДЕ ---
  onAuthStateChanged(auth, async (user) => {
      if (user) {
          currentUser = user;
          // Быстро грузим профиль
          const snap = await get(ref(db, 'users/' + user.uid));
          myProfile = snap.val();
          
          document.getElementById('my-display-name').innerText = myProfile.displayName;
          
          UI.loading.style.display = 'none';
          UI.auth.style.display = 'none';
          UI.app.style.display = 'flex';
          closeSettings();
      } else {
          currentUser = null;
          UI.loading.style.display = 'none';
          UI.auth.style.display = 'flex';
          UI.app.style.display = 'none';
      }
  });

  // --- ПОИСК ЛЮДЕЙ ПО @ЮЗЕРНЕЙМУ ---
  window.searchUsers = async () => {
      const query = document.getElementById('search-input').value.trim().toLowerCase();
      if(!query || !query.startsWith('@')) {
          UI.userList.innerHTML = '<div style="padding: 10px; text-align: center; color: #888; font-size: 13px;">Введите @юзернейм полностью</div>';
          return;
      }

      // Ищем точное совпадение юзернейма
      const usernameSnap = await get(ref(db, 'usernames/' + query));
      if(usernameSnap.exists()) {
          const targetUid = usernameSnap.val();
          if(targetUid === currentUser.uid) return; // Самого себя не показываем

          const userSnap = await get(ref(db, 'users/' + targetUid));
          const userData = userSnap.val();

          UI.userList.innerHTML = `
              <div class="user-item" onclick="openChat('${targetUid}', '${userData.displayName}')">
                  <img src="${userData.avatar}" class="avatar">
                  <div class="user-info">
                      <span class="user-name">${userData.displayName}</span>
                      <span class="user-nick">${userData.username}</span>
                  </div>
              </div>
          `;
      } else {
          UI.userList.innerHTML = '<div style="padding: 10px; text-align: center; color: #888; font-size: 13px;">Пользователь не найден</div>';
      }
  };

  // --- ПРИВАТНЫЕ ЧАТЫ ---
  // Генерация уникального ID чата для двух людей
  function getChatId(uid1, uid2) {
      return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
  }

  window.openChat = (partnerUid, partnerName) => {
      // Отключаем прослушку старого чата
      if(currentChatListener && activeChatId) {
          off(ref(db, 'chats/' + activeChatId));
      }

      activeChatId = getChatId(currentUser.uid, partnerUid);
      UI.activeChatName.innerText = partnerName;
      UI.msgContainer.innerHTML = ''; // Очищаем экран
      UI.inputArea.style.display = 'flex';

      // Грузим сообщения этого чата
      currentChatListener = onChildAdded(ref(db, 'chats/' + activeChatId), (data) => {
          const msg = data.val();
          const isMine = msg.sender === currentUser.uid;
          const time = new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          
          const div = document.createElement('div');
          div.className = `msg-row ${isMine ? 'mine' : 'others'}`;
          div.innerHTML = `
              <div class="msg-bubble">
                  ${msg.text}
                  <span class="msg-time">${time}</span>
              </div>
          `;
          UI.msgContainer.appendChild(div);
          UI.msgContainer.scrollTop = UI.msgContainer.scrollHeight;
      });
  };

  window.sendPrivateMessage = () => {
      const input = document.getElementById('msg-input');
      const text = input.value.trim();
      if(text !== "" && activeChatId) {
          push(ref(db, 'chats/' + activeChatId), {
              sender: currentUser.uid,
              text: text,
              time: Date.now()
          });
          input.value = "";
      }
  };

  document.getElementById('msg-input').addEventListener('keypress', e => {
      if(e.key === 'Enter') sendPrivateMessage();
  });

  // --- НАСТРОЙКИ ---
  window.openSettings = () => {
      document.getElementById('set-name').value = myProfile.displayName;
      document.getElementById('set-avatar').value = myProfile.avatar;
      document.getElementById('settings-modal').style.display = 'flex';
  };
  
  window.closeSettings = () => {
      document.getElementById('settings-modal').style.display = 'none';
  };

  window.saveSettings = async () => {
      const newName = document.getElementById('set-name').value;
      const newAvatar = document.getElementById('set-avatar').value;
      
      await set(ref(db, 'users/' + currentUser.uid + '/displayName'), newName);
      await set(ref(db, 'users/' + currentUser.uid + '/avatar'), newAvatar);
      
      myProfile.displayName = newName;
      myProfile.avatar = newAvatar;
      document.getElementById('my-display-name').innerText = newName;
      closeSettings();
  };
</script>

</body>
</html>
